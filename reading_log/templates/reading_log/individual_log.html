{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load reading_log %}

{% block content %}

<ul class="list-group mb-4">
  <li class="list-group-item"> {{ page_user_name }}さんの読書ログ </li>
</ul>

<form class="mt-2" id="search-form" action="" method="GET">
  <div>
    <label class="label mr-4">年月</label>
    {{ search_form.year }}
    {{ search_form.month }}
  </div>

  <div class="mt-4">
    {{ search_form.key_word }}
    <button class="btn btn-primary btn-lg" type="submit">検索</button>
  </div>
  <div class="mt-2 inline">
    {{ search_form.tag }}
  </div>
</form>

<p class="search-result mt-3"> {{ page_obj.paginator.count }}件の検索結果 </p>

<!-- 一覧表示 -->
<table class="table mt-3">
  <tr>
    <th>書籍</th>
    <th>著者</th>
    <th>状態</th>
    <th>読了月</th>
    <th>タグ</th>
    {% if user.is_authenticated and page_user_id == user.id %}
    <th>編集</th>
    {% endif %}
  </tr>
  {% for reading_log in reading_log_list %}

  <tr>
    <td>{{ reading_log.book.title }}</td>
    <td>{{ reading_log.book.author }}</td>
    <td>{{ reading_log.status }}</td>
    <td>
      {% if reading_log.finish_date %}
      {{ reading_log.finish_date|date:"Y年m月" }}
      {% endif %}
    </td>
    <td>
      {% if reading_log.book.tags.names %}
        {% for tag in reading_log.book.tags.names %}
          {% if forloop.last %}
            {{ tag }}
          {% else %}
            {{ tag }},
          {% endif %}
        {% endfor %}
      {% endif %}
    </td>
    {% if user.is_authenticated and page_user_id == user.id %}
    <td>
      <div class="manage-btn-area">
        <div class="update-btn-area">
          <a class="btn btn-outline-primary btn-lg" href="{% url 'reading_log:reading_log_update' reading_log.pk %}">更新</a>
        </div>
        <div class="delete-btn-area">
          <a class="btn btn-outline-danger btn-lg" href="{% url 'reading_log:reading_log_delete' reading_log.pk %}">削除</a>
        </div>
      </div>
    </td>
    {% endif %}
  </tr>
  {% endfor %}
</table>

<!-- ページネーション -->
{% if is_paginated %}
<ul class="pagination pagination-lg justify-content-center mt-5">
  {% for i in paginator_range %}
    {% if page_obj.number == i %}
      <li class="active page-item">
        <span class="page-link">{{ i }}</span>
      </li>
    {% else %}
      {% if i == paginator.ELLIPSIS %}
        <li class="page-item">
          <span class="page-link">{{ paginator.ELLIPSIS }}</span>
        </li>
      {% else %}
        <li class="page-item">
          <a class="page-link" href="?page={{ i }}">{{ i }}</a>
        </li>
      {% endif %}
    {% endif %}
  {% endfor %}
</ul>
{% endif %}


{% endblock %}

{% block extrajs %}
<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', e => {
    const searchForm = document.getElementById('search-form');

    //タグがクリックされたら検索実行
    for (const check of document.getElementsByName('tag')) {
      check.addEventListener('change', () => {
        searchForm.submit();
      });
    }

    // 選択済みのタグがクリックされたらチェックを解除して検索実行
    const selectedTag = document.querySelector(`input[name='tag']:checked`)
    if (selectedTag) {
      selectedTag.onclick = () => {
        selectedTag.checked = false
        searchForm.submit();
      }
    }
  });
</script>
{% endblock %}
